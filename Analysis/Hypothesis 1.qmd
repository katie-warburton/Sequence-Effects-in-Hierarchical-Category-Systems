---
title: "Hypothesis 1"
author: "Katie Warburton"
format: html
editor: visual
execute:
    code-fold: true
    code-summary: "Show the code"
---

### Imports

```{r message=FALSE, warning=FALSE, results='hide'}
library(stringr) 
library(tidyverse) 
library(dplyr) 
library(lme4) 
library(ggplot2) 
library(lmtest) 
library(brms) 
library(tidybayes) 
library(parameters) 
library(mclogit) 

set.seed(13)

```

### Data

```{r}
df <- read.csv('Results/level2_trial_data.csv',  na.strings=c("","NA"))  
items <- sprintf("I%02d", 9:23)
```

## Hypothesis 1a

Order affects the assignment of items to categories A, B, X

```{r}
df_1a <-  select(df, c(LOC, ORDER, NUM_A, NUM_X, NUM_B, P_ID, STIMULI, POOL))
df_1a <- df_1a[df_1a$ORDER != 'a',]
```

### Left

```{r}
df_L <- df_1a[df_1a$LOC == 'L',]
df_L %>%
  group_by(P_ID) %>%
  summarise(n_trials = n()) %>% 
  group_by(n_trials) %>% 
  summarise(participants = n()) 

df_L$TRIALS <- df_L$NUM_A + df_L$NUM_X + df_L$NUM_B
```

```{r}
lm_1_1 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1 + ORDER,
   random = list(~1|STIMULI,  ~1|POOL/P_ID),
   control = mmclogit.control(inner.optimizer = "BFGS"),
   data = df_L)

lm_1 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1 + ORDER,
   random = list(~1|STIMULI,  ~1|P_ID),
   control = mmclogit.control(inner.optimizer = "BFGS"),
   data = df_L)

lm_0 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1,
   random = list( ~1|STIMULI, ~1|P_ID),
    control = mmclogit.control(inner.optimizer = "BFGS"),
   data = df_L)

l_anova <- anova(lm_0, lm_1, test = "LRT")
l_anova

if (l_anova[["Pr(>Chi)"]][2] < 0.05){
  l_hyp <- "supported"
} else {
  l_hyp <- "unsupported"
}
```

The hypothesis is `r l_hyp` in the left-shifted condition.

```{r}
anova(lm_1, lm_1_1, test = "LRT")
```

```{r}
```

### Centered

```{r}
df_C <- df_1a[df_1a$LOC == 'C',]
df_C %>%
  group_by(P_ID) %>%
  summarise(n_trials = n()) %>% 
  group_by(n_trials) %>% 
  summarise(participants = n())
```

```{r}
cm_1 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1 + ORDER,
   random = list(~1|STIMULI, ~1|POOL/P_ID),
   control = mmclogit.control(maxit = 1000, inner.optimizer = "BFGS"),
   data = df_C)

cm_0 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1,
   random = list( ~1|STIMULI, ~1|POOL/P_ID),
    control = mmclogit.control(maxit = 1000, inner.optimizer = "BFGS"),
   data = df_C)

c_anova <- anova(cm_1, cm_0, test = "LRT")
c_anova
if (c_anova[["Pr(>Chi)"]][2] < 0.05){
  c_hyp <- "supported"
} else {
  c_hyp <- "unsupported"
}
```

The hypothesis is `r c_hyp` in the centered condition.

```{r}
df_R <- df_1a[df_1a$LOC == 'R',]
df_R %>%
  group_by(P_ID) %>%
  summarise(n_trials = n()) %>% 
  group_by(n_trials) %>% 
  summarise(participants = n())

```

### Right

```{r}
rm_1 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1 + ORDER,
   random = list(~1|STIMULI, ~1|POOL), 
   control = mmclogit.control(maxit = 1000, inner.optimizer = "BFGS"),
   data = df_R)

rm_0 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1,
   random = list( ~1|STIMULI, ~1|POOL),
    control = mmclogit.control(maxit = 1000, inner.optimizer = "BFGS"),
   data = df_R)

r_anova <- anova(rm_1, rm_0, test = "LRT")
r_anova
if (r_anova[["Pr(>Chi)"]][2] < 0.05){
  r_hyp <- "supported"
} else {
  r_hyp <- "unsupported"
}
```

The hypothesis is `r r_hyp` in the right-shifted condition.

### Overall

```{r}
df_1a %>%
  group_by(P_ID) %>%
  summarise(n_trials = n()) %>% 
  group_by(n_trials) %>% 
  summarise(participants = n())


```

```{r}
m_1 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1 + ORDER,
   random = list(~1|STIMULI,  ~1|POOL/P_ID, ~1|LOC), 
   control = mmclogit.control(inner.optimizer = "BFGS"),
   data = df_1a)

m_0 <- mblogit(
   formula = cbind(NUM_X, NUM_A, NUM_B) ~ 1,
   random = list( ~1|STIMULI, ~1|POOL/P_ID, ~1|LOC),
    control = mmclogit.control(inner.optimizer = "BFGS"),
   data = df_1a)
```

```{r}
anova <- anova(m_0, m_1, test = "LRT")
anova

if (anova[["Pr(>Chi)"]][2] < 0.05){
  hyp <- "supported"
} else {
  hyp <- "unsupported"
}
```

The hypothesis is `r hyp` overall (with a random intercept for location).

## Hypothesis 1b

Items in the centered location are more likely to be assigned to category:

\(i\) A in the forwards order than in the backwards order

```{r}
df_1bi <- df_C[df_C$ORDER != 'm',]
df_1bi$NOT_A <- df_1bi$NUM_B + df_bi$NUM_X
df_1bi %>%
  group_by(P_ID) %>%
  summarise(n_trials = n()) %>% 
  group_by(n_trials) %>% 
  summarise(participants = n())

```

```{r}


mbi_1 <- glmer( cbind(NUM_A, NOT_A) ~ 1 + ORDER + (1|STIMULI) + (1|P_ID) ,
              family = binomial,
              data = df_1bi)

mbi_0 <- glmer(cbind(NUM_A, NOT_A) ~ 1 + (1|STIMULI) + (1|P_ID),
                   data = df_1bi,
                   family = binomial)

summary(mbi_1)
lrtest(mbi_0, mbi_1)

# bb_mbi <- brm(NUM_A | trials(9) ~ 1 + ORDER + (1|STIMULI) + (1|POOL),
#               family = binomial(link="logit"),
#               iter = 4000,
#               cores =4, 
#               control = list(adapt_delta = 0.95),
#               data = df_1bi)
# 
# fixef(bb_mbi)
```

\(ii\) B in the backwards order than in the forwards order

```{r}
df_bii <- df_C[df_C$ORDER != 'm',]
df_bii$NOT_B <- df_bi$NUM_A + df_bi$NUM_X
df_bii$ORDER <- relevel(factor(df_bii$ORDER), ref = 'f')

mbii_1 <- glmer( cbind(NUM_B, NOT_B) ~ 1 + ORDER + (1|STIMULI) + (1|P_ID),
              family = binomial,
              data = df_bii)

mbii_0 <- glmer(cbind(NUM_B, NOT_B) ~ 1 + (1|STIMULI) + (1|P_ID),
                   data = df_bii,
                   family = binomial)

summary(mbii_1)
lrtest(mbii_0, mbii_1)

# bb_mbii <- brm(NUM_B | trials(9) ~ 1 + ORDER + (1|STIMULI) + (1|P_ID),
#               family = binomial(link="logit"),
#               iter = 4000,
#               cores = 4, 
#               control = list(adapt_delta = 0.95),
#               data = df_bii)
# 
# fixef(bb_mbii)
```

\(iii\) X in the middle order than in the forwards or backwards orders

```{r}
df_biii <- df_C
df_biii$NOT_X <- df_biii$NUM_A + df_biii$NUM_B
df_biii$ORDER[df_biii$ORDER != 'm'] <- 'not_m'
df_biii$ORDER <- relevel(factor(df_biii$ORDER), ref = 'not_m')


mbiii_1 <- glmer( cbind(NUM_X, NOT_X) ~ 1 + ORDER  + (1|STIMULI) + (1|P_ID),
              family = binomial,
                control = glmerControl(optimizer = "bobyqa"),
              data = df_biii)

mbiii_0 <- glmer(cbind(NUM_X, NOT_X) ~ 1 + (1|STIMULI) + (1|P_ID),
                   data = df_biii,
                   control = glmerControl(optimizer = "bobyqa"),
                   family = binomial)

summary(mbiii_1)
lrtest(mbiii_0, mbiii_1)

# bb_mbiii <- brm(NUM_X | trials(9) ~ 1 + ORDER + (1|STIMULI) + (1|P_ID),
#               family = binomial(link="logit"),
#               iter = 4000,
#               cores = 4,
#               control = list(adapt_delta = 0.95),
#               data = df_biii)
# 
# fixef(bb_mbiii)
```

## Hypothesis 1c

Items in the left-shifted location are more likely to be assigned to category A in the forwards order than in the backwards order.

```{r}
df_1c <- df_L[df_L$ORDER != 'm',]
df_1c$NOT_A <- df_1c$NUM_B + df_1c$NUM_X

m1c_1 <- glmer(cbind(NUM_A, NOT_A) ~ 1 + ORDER + (1|STIMULI) + (1|POOL) ,
              family = binomial,
              data = df_1c)

m1c_0 <- glmer(cbind(NUM_A, NOT_A) ~ 1 + (1|STIMULI) + (1|POOL),
                   data = df_1c,
                   family = binomial)

summary(m1c_1)
lrtest(m1c_0, m1c_1)
# 
# bb_m1c <- brm(NUM_A | trials(9) ~ 1 + ORDER + (1|STIMULI) + (1|POOL),
#               family = binomial(link="logit"),
#               iter = 4000,
#               cores = 4,
#               control = list(adapt_delta = 0.95),
#               data = df_1c)
# 
# fixef(bb_m1c)

```

## Hypothesis 1d

Items in the right-shifted location are more likely to be assigned to category B in the backwards order than in the forwards order

```{r}
df_1d <- df_R[df_R$ORDER != 'm',]
df_1d$NOT_B <- df_1d$NUM_A + df_1d$NUM_X
df_1d$ORDER <- relevel(factor(df_1d$ORDER), ref='f')

m1d_1 <- glmer(cbind(NUM_B, NOT_B) ~ 1 + ORDER + (1|STIMULI) + (1|POOL) ,
              family = binomial,
              data = df_1d)

m1d_0 <- glmer(cbind(NUM_B, NOT_B) ~ 1 + (1|STIMULI) + (1|POOL),
                   data = df_1d,
                   family = binomial)

summary(m1d_1)
lrtest(m1d_0, m1d_1)

# bb_m1d <- brm(NUM_B | trials(9) ~ 1 + ORDER + (1|STIMULI) + (1|P_ID),
#               family = binomial(link="logit"),
#               iter = 4000,
#               cores = 4,
#               control = list(adapt_delta = 0.95),
#               data = df_1d)
# 
# fixef(bb_m1d)

```
